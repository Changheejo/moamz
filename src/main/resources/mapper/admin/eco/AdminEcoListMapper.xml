<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.moamz.mapper.admin.eco.AdminEcoMapper">

<!--진행중인 에코프로젝트 목록 보여주기-->
    <select id="selectIngEcoList" resultType="AdminEcoListDTO">
        SELECT DISTINCT PF.FG_POST_FILE_ROOT, PF.FG_POST_FILE_NAME, PF.FG_POST_FILE_UUID,
                        P.FG_POST_TITLE, P.FG_POST_LIKES,
                        E.FG_ECO_START, E.FG_ECO_END, E.FG_ECO_POINTS, E.FG_ECO_INFO, E.FG_CERT_INFO, E.FG_ECO_PARTICIPATION
        FROM FG_POST_FILE PF
                 JOIN FG_POST P ON PF.FG_POST_ID = P.FG_POST_ID
                 JOIN FG_ECO E ON P.FG_POST_ID = E.FG_POST_ID
        WHERE P.FG_POST_TYPE = 'eco' AND E.FG_ECO_STATUS = '1';
    </select>

<!--종료된 에코프로젝트 목록 보여주기 -->
    <select id="selectFinEcoList" resultType="AdminEcoListDTO">
        SELECT  DISTINCT PF.FG_POST_FILE_ROOT, PF.FG_POST_FILE_NAME, PF.FG_POST_FILE_UUID,
                         P.FG_POST_TITLE, P.FG_POST_LIKES,
                         E.FG_ECO_START, E.FG_ECO_END, E.FG_ECO_POINTS, E.FG_ECO_INFO, E.FG_CERT_INFO, E.FG_ECO_PARTICIPATION
        FROM FG_POST_FILE PF
                 JOIN FG_POST P ON PF.FG_POST_ID = P.FG_POST_ID
                 JOIN FG_ECO E ON P.FG_POST_ID = E.FG_POST_ID
        WHERE P.FG_POST_TYPE = 'eco' AND E.FG_ECO_STATUS = '0';
    </select>

<!--에코프로젝트 글 작성하기 (공통게시글테이블 insert)-->
    <insert id="insertEcoPost" parameterType="AdminEcoWriteDTO">
        <selectKey keyProperty="fgPostId" resultType="Long" order="BEFORE">
            SELECT SEQ_POST.nextval FROM DUAL
        </selectKey>
        INSERT INTO FG_POST (FG_POST_ID, FG_POST_TYPE, FG_POST_TITLE, FG_POST_CREATED_AT, FG_USER_CODE)
        VALUES (#{fgPostId}, 'eco', #{fgPostTitle}, SYSDATE, (SELECT FG_USER_CODE FROM FG_COMMON_USER WHERE FG_USER_ID = '관리자'));
    </insert>

<!--에코프로젝트 글 작성하기 (에코프젝테이블 insert)-->
    <insert id="insertEcoReal" parameterType="AdminEcoWriteDTO">
        INSERT INTO FG_ECO (FG_POST_ID, FG_ECO_START, FG_ECO_END, FG_ECO_PARTICIPATION, FG_ECO_INFO, FG_CERT_INFO, FG_ECO_POINTS)
        VALUES (#{fgPostId}, #{fgEcoStart}, #{fgEcoEnd}, #{fgParticipation}, #{fgEcoInfo}, #{fgCertInfo}, #{fgEcoPoints});
    </insert>

<!--에코프젝 글 작성하기 (썸네일 삽입)-->

<!--에코프젝  글 수정하기 (공통게시글테이블 UPDATE / 수정여부 업데이트) -->
    <update id="modifyEco" parameterType="AdminEcoModifyDTO">
        UPDATE FG_POST
        SET  FG_POST_EDIT = '1'
        WHERE FG_POST_ID = #{fgPostId};
    </update>

<!--에코프젝 글 수정하기 (에코프젝테이블 UPDATE)-->
    <update id="modifyEcoReal" parameterType="AdminEcoModifyDTO">
        UPDATE FG_ECO
        SET
            FG_ECO_START = #{fgEcoStart},
            FG_ECO_END = #{fgEcoEnd},
            FG_ECO_INFO = #{fgEcoInfo},
            FG_CERT_INFO = #{fgCertInfo}
        WHERE
            FG_POST_ID = 1;
    </update>

<!--에코프젝 글 수정하기 (썸네일 수정) -->


<!--에코프젝 종료시키기 버튼 클릭시 (처음엔 무조건  FG_ECO_STATUS = '0') -->
<update id="finishBtn" parameterType="AdminEcoStatusUpdateDTO">
    UPDATE FG_ECO
    SET
        FG_ECO_STATUS = '0'
    WHERE
        FG_POST_ID = '1';
</update>

<!--(진행중/종료된) 특정 한 에코 프로젝트의 인증글 목록보기-->
<select id="selectEcoCertList" parameterType="Long" resultType="AdminEcoCertListDTO">
    SELECT DISTINCT p.FG_POST_ID, ec.FG_PROJECT_ID , p.FG_POST_TITLE, nu.FG_NORMAL_NICKNAME, p.FG_POST_CREATED_AT,p.FG_POST_LIKES
    FROM FG_POST p
             JOIN FG_NORMAL_USER nu ON p.FG_USER_CODE = nu.FG_USER_CODE
             JOIN FG_ECO_CERT ec ON p.FG_POST_ID = ec.FG_POST_ID
             JOIN FG_ECO e ON ec.FG_PROJECT_ID  = e.FG_POST_ID
    WHERE FG_POST_TYPE = 'ecoCert' AND ec.FG_PROJECT_ID =#{fgProjectId}
    ORDER BY p.FG_POST_LIKES DESC;
</select>

<!--에코프젝 인증글 상세 보기-->
<select id="selectEcoCertDetail" parameterType="Long" resultType="AdminEcoCertDetailDTO">
    SELECT p.FG_POST_TITLE,
           uf.FG_USER_FILE_ROOT,uf.FG_USER_FILE_NAME,uf.FG_USER_FILE_UUID,
           nu.FG_NORMAL_NICKNAME,
           p.FG_POST_CREATED_AT,p.FG_POST_LIKES,
           ec.FG_CERT_CONTENT
    FROM FG_POST p
             JOIN FG_COMMON_USER cu ON p.FG_USER_CODE = cu.FG_USER_CODE
             JOIN FG_USER_FILE uf ON p.FG_USER_CODE = uf.FG_USER_CODE
             JOIN FG_NORMAL_USER nu ON p.FG_USER_CODE = nu.FG_USER_CODE
             JOIN FG_ECO_CERT ec ON p.FG_POST_ID = ec.FG_POST_ID
    WHERE p.FG_POST_TYPE = 'ecoCert' AND p.FG_POST_ID = #{fgPostId} AND ec.FG_PROJECT_ID = #{fgProjectId};
</select>

<!--에코프젝 인증글 상세보기 - 댓글부분 <=adminCommentDTO에서 처리 할 듯...-->

<!--에코프젝 인증글 - 포인트 지급하기 (인증글 쓴사람의 회원번호 알아내기)-->
<select id="selectEcoPointReceiver" parameterType="Long" resultType="AdminEcoCertPointBtnDTO">
    SELECT FG_USER_CODE
    FROM FG_POST p
             JOIN FG_ECO_CERT  e ON p.FG_POST_ID = e.FG_POST_ID
    WHERE e.FG_POST_ID = #{fgPostId};
</select>

<!--에코프젝 인증글 - 포인트 지급하기(해당 유저의 포인트 업데이트하기)-->
<update id="updateUserEcoPoint" parameterType="Long">
    UPDATE FG_POINT
    SET FG_POINT_TOTAL = FG_POINT_TOTAL + 100
    WHERE FG_USER_CODE = (  SELECT FG_USER_CODE
                            FROM FG_POST p
                                     JOIN FG_ECO_CERT  e ON p.FG_POST_ID = e.FG_POST_ID
                            WHERE e.FG_POST_ID = #{fgPostId});
</update>

<!--에코프젝 인증글 -포인트 지급 내역 기록하기 -->
<insert id="insertEcoPointLog" parameterType="AdminEcoCertPointBtnDTO">
    <selectKey keyProperty="fgPointDetailId" resultType="Long" order="BEFORE">
        SELECT SEQ_TEST_POINT_DETAIL.nextval FROM DUAL
    </selectKey>
    INSERT INTO FG_POINT_DETAIL (FG_POINT_DETAIL_ID, FG_POINT_RECEIVED_DATE, FG_POINT_RECEIVED, FG_POINT_ID)
    VALUES (
               SEQ_TEST_POINT_DETAIL.NEXTVAL, SYSDATE, 100,
               (SELECT FG_POINT_ID FROM FG_POINT WHERE FG_USER_CODE =
                                                       (SELECT P.FG_USER_CODE
                                                        FROM FG_POST P
                                                                 JOIN FG_ECO_CERT EC ON P.FG_POST_ID = EC.FG_POST_ID
                                                        WHERE EC.FG_POST_ID = #{fgPostId}))
           );
</insert>















</mapper>